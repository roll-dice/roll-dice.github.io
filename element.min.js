"roads-technology.nl"==location.host&&console.log("This code is a mess, but it works");var DEBUG=0;import*as e from"https://cdn.skypack.dev/cannon-es";import*as t from"./dependencies/three.min.js";import*as i from"./dependencies/BufferGeometryUtils.js";function INITDICE({customElement:e,THREE:t,CANNON:i,BufferGeometryUtils:o}){e.log=e.hasAttribute("log"),DEBUG=e.hasAttribute("debug");var a=(t,i=!1)=>e.getAttribute(t)||i||!1,n=document.querySelector("#canvas"),{width:r,height:s}=n.getBoundingClientRect(),l=e.parentNode.getBoundingClientRect(),l=n.getBoundingClientRect(),d=l.top;l.left;var c,$=[],h=n.offsetWidth,u=n.offsetHeight,m=DEBUG&&1,y=~~a("dicecount",5),p=void 0,_=5,w=1,g=40+5*_,v=[0,_,w],x=g/10-.5,f=g/10-.5,z=[],b=a("dicecolor","white"),S=a("diceselectedcolor","lightgreen"),B=a("dicehovercolor","beige"),M=a("dotcolor","black"),E=28,I=[[0,6,0],[-2,6,-2],[2,6,-2],[-2,6,2],[2,6,2],],P=[0,[0],[-.75,.75],[-1.2,.25,1.7],[-1,-1,1,1],[-1,-1,.5,2,2],[-1.75,0,1.7,-1.75,0,1.7],][y],A=[0,[8],[6,6],[6,6,6],[6,6,6,6],[7,7,7,7,7,7],[6.5,6.5,6.5,6.5,6.5,6.5]][y],L=[0,[1.5],[1,1.5],[1,1,1],[-.5,1,1,-.5],[.125,2.25,1.25,2.25,.125],[.5,.5,.5,2,2,2]][y],[G=0,k=0,q=0]=(a("aligndice")||"0,0,0").split(",");DEBUG&&console.warn("aligned",P,A,L,"\n",G),G=Number(G),k=Number(k),q=Number(q);var T=a("mass",1.5),C=a("gravityx",-4),D=-a("gravityy",50),U=a("gravityz",0),j=[C,D,U],V=a("diceimpulse",5),X=a("dicerotation",.6),Y=a("restitution",.6);DEBUG&&(j[1]=-550),Y=.06;var R=(e=0,i=0)=>new t.Vector2(e,i),H=(e=0,i=0,o=0)=>new t.Vector3(e,i,o),F=(e=0,t=0,o=0)=>new i.Vec3(e,t,o),N=e=>new i.Body(e),Z=e=>new i.Box(e),W=()=>{ee.render(et,w)},Q=e=>e*(Math.PI/180);class O{constructor(){var i,a,n,r,s,l,d=this,c=d.mesh=(a=[new t.MeshStandardMaterial({color:b,wireframe:!1}),new t.MeshStandardMaterial({color:b,wireframe:!1}),new t.MeshStandardMaterial({color:b,wireframe:!1}),new t.MeshStandardMaterial({color:b,wireframe:!1}),new t.MeshStandardMaterial({color:b,wireframe:!1}),new t.MeshStandardMaterial({color:b,wireframe:!1})],n=new t.MeshStandardMaterial({color:M,roughness:0,metalness:1,side:t.DoubleSide}),r=new t.Group,s=new t.Mesh((i=new t.PlaneGeometry(.74,.74),o.mergeGeometries([i.clone().translate(0,0,-.485),i.clone().rotateY(.5*Math.PI).translate(.485,0,0),i.clone().translate(0,0,.485),i.clone().rotateX(.5*Math.PI).translate(0,.485,0),i.clone().rotateY(.5*Math.PI).translate(-.485,0,0),i.clone().rotateX(.5*Math.PI).translate(0,-.485,0)],!1)),n),l=new t.Mesh(function e(){for(var i=1,a=new t.BoxGeometry(i,i,i,E,E,E),n=a.attributes.position,r=.37,s=0;s<n.count;s++){var l=H().fromBufferAttribute(n,s),d=H(Math.sign(l.x),Math.sign(l.y),Math.sign(l.z)).multiplyScalar(r),c=H().subVectors(l,d);Math.abs(l.x)>r&&Math.abs(l.y)>r&&Math.abs(l.z)>r?(c.normalize().multiplyScalar(.13),l=d.add(c)):Math.abs(l.x)>r&&Math.abs(l.y)>r?(c.z=0,c.normalize().multiplyScalar(.13),l.x=d.x+c.x,l.y=d.y+c.y):Math.abs(l.x)>r&&Math.abs(l.z)>r?(c.y=0,c.normalize().multiplyScalar(.13),l.x=d.x+c.x,l.z=d.z+c.z):Math.abs(l.y)>r&&Math.abs(l.z)>r&&(c.x=0,c.normalize().multiplyScalar(.13),l.y=d.y+c.y,l.z=d.z+c.z);var $=e=>.13*(Math.cos(e=Math.PI*Math.max(-1,Math.min(1,e*=7.692307692307692)))+1),h=e=>$(e[0])*$(e[1]);.5===l.y?l.y-=h([l.x,l.z]):.5===l.x?(l.x-=h([l.y+.25,l.z+.25]),l.x-=h([l.y-.25,l.z-.25])):.5===l.z?(l.z-=h([l.x-.25,l.y+.25]),l.z-=h([l.x,l.y]),l.z-=h([l.x+.25,l.y-.25])):-.5===l.z?(l.z+=h([l.x+.25,l.y+.25]),l.z+=h([l.x+.25,l.y-.25]),l.z+=h([l.x-.25,l.y+.25]),l.z+=h([l.x-.25,l.y-.25])):-.5===l.x?(l.x+=h([l.y+.25,l.z+.25]),l.x+=h([l.y+.25,l.z-.25]),l.x+=h([l.y,l.z]),l.x+=h([l.y-.25,l.z+.25]),l.x+=h([l.y-.25,l.z-.25])):-.5===l.y&&(l.y+=h([l.x+.25,l.z+.25]),l.y+=h([l.x+.25,l.z]),l.y+=h([l.x+.25,l.z-.25]),l.y+=h([l.x-.25,l.z+.25]),l.y+=h([l.x-.25,l.z]),l.y+=h([l.x-.25,l.z-.25])),n.setXYZ(s,l.x,l.y,l.z)}return a.deleteAttribute("normal"),a.deleteAttribute("uv"),(a=o.mergeVertices(a)).computeVertexNormals(),a}(),a),l.castShadow=!0,r.add(s,l),r),$=c.position,h=c.rotation,u=N({mass:T,shape:Z(F(.5,.5,.5)),sleepTimeLimit:.1});this.animating=!1,et.add(c),K.addBody(u),Object.assign(this,{mesh:c,body:u,X(e=0){$.x=e,W()},Y(e=0){$.y=e,W()},Z(e=0){$.z=e,W()},moveTo:({x:e=$.x,y:t=$.y,z:i=$.z,speed:o=1,vector:a=H(e,t,i)})=>{this.animating=!0,setTimeout(()=>this.animating=!1,3e3);var n=()=>{var r=a.clone().sub($);this.animating&&r.length()>=1?(r.normalize().multiplyScalar(o),$.add(r),requestAnimationFrame(n)):(this.animating=!1,$.copy(a),u.position.copy(a),$.x=e,$.y=t,$.z=i,customElements.log&&console.warn("done moveTo",u.id,"value:",this.value,"P:",$,"\n",r)),W()};n()},toFloor:({y:e=0,delay:t=0})=>{let i=()=>{this.animating?setTimeout(i,100):(customElements.log&&console.error("wait for animating false",this.animating),setTimeout(()=>{this.moveTo({x:$.x+[-1.5,-.5,0,1,2,2.5,3,3.3][this.sortidx],y:e,z:0})},t))};i()},select:()=>{this.selected=!this.selected,this.color=this.selected?S:b,this.moveTo({x:(this.selected,P[this.sortidx]),y:this.selected?Number(e.getAttribute("selectedheight")):A[this.sortidx],z:(this.selected,L[this.sortidx])}),e.dispatch("dice-selected",{selecteddice:this}),W()},rotateTo({x:e=h.x,y:i=h.y,z:o=h.z,speed:a=.05}){customElements.log&&console.log(e,i,o);var n=new t.Euler().setFromQuaternion(c.quaternion);n.x=Q(e),n.y=Q(i),n.z=Q(o);var r=()=>{var{x:e,y:i,z:o}=new t.Euler().setFromQuaternion(c.quaternion),s=new t.Euler(n.x-e,n.y-i,n.z-o,"XYZ"),l=e=>e>=a&&console.warn(e,a);(animating=l(s.x)||l(s.y)||l(s.z))?(h.x+=s.x=Math.sign(s.x)*a,h.y+=s.y=Math.sign(s.y)*a,h.z+=s.z=Math.sign(s.z)*a,requestAnimationFrame(r)):h.copy(n),W()};r()},nudge(){customElements.log&&console.warn("nudge",d.id),u.applyImpulse(F((Math.random()-.5)*3,(Math.random()-.5)*3,(Math.random()-.5)*3),$)},sleep:()=>{var e,t=this;customElements.log&&console.log("sleep dice",u.id),u.allowSleep=!1;var i=F();u.quaternion.toEuler(i);var o=e=>.1>Math.abs(e),a=e=>.1>Math.abs(e-.5*Math.PI),n=e=>.1>Math.abs(.5*Math.PI+e),r=(e="")=>{customElements.log&&console.warn("nudge die",u.id,e,t.value),u.allowSleep=!0,t.nudge()},s=e=>{t.value=e,t.rolling=!1,c.position.y>1&&r("stacked dice")};o(i.z)?o(i.x)?s(1):a(i.x)?s(4):n(i.x)?s(3):.1>Math.abs(Math.PI-(e=i.x))||.1>Math.abs(Math.PI+e)?s(6):r("landed on edge1"):a(i.z)?s(2):n(i.z)?s(5):r("landed on egde2")}})}get sideorder(){return[2,5,1,6,3,4]}get material(){return this.mesh.children[1].material}get color(){return this.material.color}set color(e="white"){var t=this.material;Array.isArray(t)?t.forEach(t=>t.color.set(e)):this.material.color.set(e)}colorByValue({color:e=b,value:t=this.value}){var i=this.sideorder.indexOf(t);t&&i?this.material[i].color.set(e):this.color=e}}var J,K=(J={allowSleep:!0,gravity:F(...j)},new i.World(J));K.defaultContactMaterial.restitution=Y;var ee=new t.WebGLRenderer({alpha:!0,antialias:!0,canvas:n});ee.shadowMap.enabled=!0,ee.setPixelRatio(Math.min(window.devicePixelRatio,2));var et=new t.Scene;(w=new t.PerspectiveCamera(g,innerWidth/innerHeight,.01,300)).position.set(...v).multiplyScalar(2),w.lookAt(0,0,0),ec();var ei=new t.AmbientLight(16777215,.5);et.add(ei);var eo,ea,en=new t.PointLight(16777215,.5);en.position.set(0,25,2*x),en.castShadow=!0,en.shadow.mapSize.width=2048,en.shadow.mapSize.height=2048,en.shadow.camera.near=.1,en.shadow.camera.far=1400,et.add(en),(eo=new t.Mesh(new t.PlaneGeometry(1,1),new t.ShadowMaterial({opacity:.1}))).receiveShadow=!0,eo.position.y=-1,eo.quaternion.setFromAxisAngle(H(-1,0,0),.5*Math.PI),et.add(eo),(ea=N({type:i.Body.STATIC,shape:new i.Plane})).position.copy(eo.position),ea.quaternion.copy(eo.quaternion),K.addBody(ea),z=Array(y).fill(0).map((e,t)=>{var i=window["d"+(t+1)]=new O;return z.push(i),i.body.addEventListener("sleep",e=>i.sleep()),i});var er=new t.Raycaster;m&&et.add(new t.AxesHelper(x)),$=[F(0,4,f-.75),F(0,4,-f),F(f,4,0),F(-f,4,0)].map((e,o)=>{var a=N({mass:0});a.addShape(Z(F(x,x,0))),a.position.copy(e),K.addBody(a);var n=new t.Mesh(new t.BoxGeometry(5*f,x,.001),new t.MeshBasicMaterial(DEBUG?{color:[16711680,65280,255,16776960][o],transparent:!0,opacity:.5}:{opacity:0,transparent:!0}));if(2===o||3===o){var r=new i.Quaternion;r.setFromAxisAngle(F(0,1,0),Math.PI/2),n.rotation.y=Math.PI/2,a.quaternion.copy(r)}return n.position.copy(e),n.quaternion.copy(a.quaternion),n.visible=m,et.add(n),a}),e$(),window.addEventListener("resize",ec),e.hasAttribute("doubleclick")&&e.addEventListener("dblclick",e$);let es=document.querySelector("#roll-btn");function el(){var e=new t.BufferGeometry;e.setAttribute("position",new t.BufferAttribute(new Float32Array(6),3)),c=new t.Line(e,new t.LineBasicMaterial({color:16711680})),et.add(c),n.addEventListener("click",function(e){var i=R(e.clientX/window.innerWidth*2-1,-(2*(e.clientY/window.innerHeight))+1);(function e(i,o,a=0){var n=new t.BufferGeometry,r=new Float32Array([i,0,0,i,o,a]);n.setAttribute("position",new t.BufferAttribute(r,3));var s=new t.LineBasicMaterial({color:"green",linewidth:1}),l=new t.Line(n,s);return et.add(l),W(),l})(i.x,i.y)})}function ed(e){e.body.addEventListener("collide",t=>$.forEach(i=>{t.body===i&&(e.hitwall=i)}))}function ec(){w.aspect=h/u,w.updateProjectionMatrix(),ee.setSize(h,u);var e=H(-1,1,0).unproject(w),t=H(1,-1,0).unproject(w),i=t.x-e.x,o=t.y-e.y;DEBUG&&console.warn("updateSceneSize",i,o,e,t)}function e$(){e.dispatch("dice-throw-start");var t=()=>4*Math.PI*Math.random();z.forEach((e,i)=>{var{body:o,mesh:a}=e;if(e.selected)console.warn("hold",o.id,"value",e.value,e.mesh.position);else{customElements.log&&console.log("throw",o.id),e.rolling=!0,e.hitwall=!1,o.velocity.setZero(),o.angularVelocity.setZero();var[n,r,s]=I[i]||I[0];n+=3,o.position=F(n,r,s),a.position.copy(o.position),a.rotation.set(t(),0,t()),o.quaternion.copy(a.quaternion),o.applyImpulse(F(-V,V,0),F(X,X,-X)),o.allowSleep=!0}}),function t(){K.fixedStep();var i=!0;setTimeout(()=>i=!1,5e3),i&&z.map(e=>(e.mesh.position.copy(e.body.position),e.mesh.quaternion.copy(e.body.quaternion),e.rolling)).filter(Boolean).length?(W(),requestAnimationFrame(t)):(customElements.log&&console.log("done rolling",z.map((e,t)=>e.value)),z.sort((e,t)=>e.mesh.position.x-t.mesh.position.x).forEach((e,t)=>{e.selected=!1,e.color=b,e.sortidx=t,customElements.log&&console.log(t,e.value,e.mesh.position),e.moveTo({x:P[t]+G,y:A[t]+k,z:L[t]+q})}),e.dispatch("dice-rolled"))}()}return es&&(es.onclick=e$),n.addEventListener("mousemove",e=>{var t,i,o,a,l;t=e,i=t.clientX/r*2-1,o=-(2*((t.clientY-d)/s))+1,a=H(i,o,.5),DEBUG&&console.warn(t.clientX,t.clientY,r,s,i,o),a.unproject(w),er.set(w.position,a.sub(w.position).normalize()),l=e=>{e&&(e.color=e.selected?S:b,e.mouseover=!1),p=void 0},z.filter(e=>{if(er.intersectObject(e.mesh).length)return e.mouseover||(l(p),p=e,e.mouseover=!0,e.color=B),e;p==e&&l(e)}).length?n.style.cursor="pointer":(n.style.cursor="inherit",l(p)),W()}),n.addEventListener("click",e=>{p&&p.select()}),{dice:z,roll:e$}}customElements.define("roll-dice",class extends HTMLElement{connectedCallback(){this.innerHTML='<canvas id="canvas"></canvas>',Object.assign(this,INITDICE({customElement:this,THREE:t,CANNON:e,BufferGeometryUtils:i})),this.ondoubleclick=e=>this.roll()}dispatch(e,t={}){t=Object.assign({...t,name:e,element:this,values:()=>this.dice.map(e=>e.value)},this),console.warn("%c event: ","background:purple;color:gold",e,t),this.dispatchEvent(new CustomEvent(this.nodeName.toLowerCase(),{bubbles:!0,composed:!0,detail:t}))}}),console.log("<roll-dice> element.js loaded"),customElements.define("my-component",class extends HTMLElement{constructor(){super().attachShadow({mode:"open"}).innerHTML="<style></style>"}connectedCallback(){this.innerHTML=""}});